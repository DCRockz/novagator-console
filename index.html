<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Novagator Developer Console</title>
<style>
  body { margin:0; font-family: monospace; background:#0b0f19; color:#ccc; }
  .console { padding:10px; height:100vh; display:flex; flex-direction:column; }
  .header { display:flex; justify-content:space-between; font-weight:bold; color:#fff; }
  .line { white-space:pre-wrap; }
  .ts { color:#888; margin-right:4px; }
  .tag { margin-right:4px; font-weight:bold; }
  .OUT { color:#0f0; }
  .SYS { color:#0af; }
  .ERR { color:#f44; }
  .fade { opacity:0.85; }
  #screen { flex:1; overflow:auto; padding:5px; }
  #input { outline:none; display:inline-block; min-width:5px; }
  .prompt { color:#0af; }
</style>
</head>
<body>
<div class="console">
  <div class="header">
    <span>ðŸŸ¢ Novagator Developer Console</span>
    <span id="ver">v1.1.3</span>
  </div>
  <div id="screen"></div>
  <div><span class="prompt">âžœ </span><span id="input" contenteditable="true"></span></div>
  <div style="font-size:12px;opacity:0.6;">
    Tips: â†‘/â†“ history Â· Tab autocomplete Â· Ctrl+L clear Â· use ; to chain Â· <span id="themeIndicator">theme: auto</span>
  </div>
</div>

<!-- Fixed JS -->
<script>
;(() => {
  'use strict';

  const $ = s => document.querySelector(s);
  const screen = $("#screen");
  const input  = $("#input");
  const themeIndicator = $("#themeIndicator");
  const ver = (document.getElementById('ver')?.textContent || 'v0.0.0').trim();

  function line(msg, tag="SYS", cls=""){ 
    const el = document.createElement("div");
    el.className = `line ${cls}`;
    const ts = new Date().toLocaleTimeString();
    el.innerHTML = `<span class="ts">[${ts}]</span><span class="tag ${tag}">${tag}</span>${msg}`;
    $("#screen").appendChild(el);
    $("#screen").scrollTop = $("#screen").scrollHeight;
  }
  const ok  = m => line(escapeHtml(m), "OUT");
  const sys = m => line(escapeHtml(m), "SYS", "fade");
  const err = m => line(escapeHtml(m), "ERR");

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  const NV_DEFAULTS = Object.freeze({
    version: "1.1.3",
    apiBase: "https://example.com/api",
    statusUrl: "https://example.com/health"
  });

  const state = {
    history: JSON.parse(localStorage.getItem("nv.history") || "[]"),
    histIdx: null,
    theme:  localStorage.getItem("nv.theme") || "auto",
    aliases: JSON.parse(localStorage.getItem("nv.aliases") || "{}"),
    cfg:     JSON.parse(localStorage.getItem("nv.config")  || JSON.stringify(NV_DEFAULTS)),
    commands: {}
  };

  (function applyTheme(mode){
    const root = document.documentElement;
    if(mode === "auto") root.removeAttribute("data-theme"); else root.setAttribute("data-theme", mode);
    themeIndicator.textContent = `theme: ${mode}`;
    localStorage.setItem("nv.theme", mode);
  })(state.theme);

  const saveHistory = () => localStorage.setItem("nv.history", JSON.stringify(state.history.slice(-500)));
  const saveAliases = () => localStorage.setItem("nv.aliases", JSON.stringify(state.aliases));
  const saveConfig  = () => localStorage.setItem("nv.config",  JSON.stringify(state.cfg));

  function calcExpr(expr){
    if(!/^[0-9+\-*/().,\s%^]*$/.test(expr)) throw new Error("Unsafe characters");
    const sanitized = expr.replace(/\^/g,"**").replace(/,/g,"");
    const fn = new Function(`return (${sanitized})`);
    const v = fn();
    if(!Number.isFinite(v)) throw new Error("Invalid expression");
    return v;
  }

  const commands = {
    help(){ ok(`Commands: help, clear, echo, date, time, theme <m>, version, about, uuid, calc, store, ascii, open, net ping, alias, unalias, nv version, nv status, config get/set`); },
    clear(){ screen.innerHTML = ""; },
    echo(...a){ ok(a.join(" ")); },
    date(){ ok(new Date().toLocaleDateString()); },
    time(){ ok(new Date().toLocaleTimeString()); },
    theme(m){ m=m?.toLowerCase(); if(!["auto","light","dark"].includes(m)) return err("Usage: theme <auto|light|dark>"); localStorage.setItem("nv.theme", m); themeIndicator.textContent=`theme: ${m}`; ok(`Theme set to ${m}`); },
    version(){ ok(ver); },
    about(){ ok("Novagator Developer Console â€” HTML/JS tool for dev & QA."); },
    uuid(){ const u = crypto.randomUUID(); ok(u); },
    calc(...a){ try{ ok(String(calcExpr(a.join(" ").trim()))); }catch(ex){ err("Calc error: " + ex.message); } },
    alias(def){ if(!def){ return ok(Object.keys(state.aliases).join(", ")||"(no aliases)"); } const m=String(def).split("="); state.aliases[m[0]]=m[1]; saveAliases(); ok(`Alias set: ${m[0]} = ${m[1]}`); },
    unalias(name){ delete state.aliases[name]; saveAliases(); ok(`Alias removed: ${name}`); },
    nv(sub){ if(sub==="version") ok(`Novagator ${state.cfg.version}`); else if(sub==="status") commands["nv.status"](); else err("Usage: nv version|status"); },
    async "nv.status"(){ const u=state.cfg.statusUrl; try{ const r=await fetch(u); ok(`Status ${r.status}`); }catch{ err("Error fetching status"); } },
    config(sub,k,...rest){ if(sub==="get") ok(JSON.stringify(state.cfg,null,2)); else if(sub==="set"){ state.cfg[k]=rest.join(" "); saveConfig(); ok(`config[${k}] set`); } else err("Usage: config get|set"); }
  };
  state.commands = commands;

  function runCommand(raw){
    if(!raw?.trim()) return;
    if(state.history[state.history.length-1] !== raw){ state.history.push(raw); saveHistory(); }
    const [cmd, ...args] = raw.split(/\s+/);
    const fn = state.commands[cmd?.toLowerCase()];
    if(!fn){ err(`Unknown command: ${cmd}. Try 'help'.`); return; }
    try{ fn.apply(null, args); }catch(e){ err(e?.message || String(e)); }
  }

  function attachInputHandlers(){
    input.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        const txt = input.textContent;
        input.textContent = "";
        runCommand(txt);
      }
    });
  }

  try{
    sys("INIT OK â€” Novagator Console " + NV_DEFAULTS.version);
    attachInputHandlers();
    input.focus();
  }catch(e){
    err("Boot error: " + (e?.message || e));
  }

})();
</script>
</body>
</html>
